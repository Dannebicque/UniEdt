{% extends 'base.html' %}
{% load extra_tags %}

{% block content %}
<div style="margin:20px;">
  <h2>Programmation Partie 1</h2>

<button class="btn btn-success mb-3" onclick="saveAll()">Enregistrer tout</button>


<form method="get" class="mb-3">
  <div class="row">
    <div class="col">
      <input type="text" name="semestre" class="form-control" placeholder="Semestre (S1,S3,S5)" value="{{ semestre_filtre }}">
    </div>
    <div class="col">
      <input type="text" name="parcours" class="form-control" placeholder="Parcours (BUT1,DEV-FI,DEV-FC,CREACOM)" value="{{ parcours_filtre }}">
    </div>
    <div class="col">
      <input type="text" name="code" class="form-control" placeholder="Code matière" value="{{ code_filtre }}">
    </div>
    <div class="col">
      <input type="text" name="prof" class="form-control" placeholder="Prof" value="{{ prof_filtre }}">
    </div>
    <div class="col">
      <input type="text" name="type" class="form-control" placeholder="Type (CM,TD,TP)" value="{{ type_filtre }}">
    </div>
    <div class="col">
      <button type="submit" class="btn btn-primary">Filtrer</button>
      <a href="{% url 'programmation:partie1' %}" class="btn btn-secondary">Réinitialiser</a>
    </div>
  </div>
</form>


  <table class="table table-bordered table-sm">
    <thead>
      <tr>
        <th>F</th><th>SEMESTRE</th><th>PARCOURS</th><th>CODE</th><th>BLOC</th>
        <th>PROF</th><th>TYPE</th><th>NB_COURS</th><th>NB_GROUPES</th><th>GROUPES</th>
        {% for i in semaines %}<th>S{{ i }}</th>{% endfor %}
        <th>ACTION</th>
      </tr>
    </thead>
    <tbody>
      {% for ligne in programmation %}
      <tr>
        <td><input type="checkbox" {% if ligne.Fixed == 1 %}checked{% endif %}></td>
        <td>{{ ligne.semestre }}</td>
        <td>{{ ligne.parcours }}</td>
        <td {% if ligne.depasse %}style="color:red;"{% elif ligne.complet %}style="color:green;"{% endif %}>
          {{ ligne.code_matiere }}</td>
        <td>{{ ligne.block }}</td>
        <td>{{ ligne.code_prof }}</td>
        <td>{{ ligne.type }}</td>
        <td>{{ ligne.nb_cours }}</td>
        <td>{{ ligne.nb_groupes }}</td>
        <td contenteditable="true">{% if ligne.groupes %}{{ ligne.groupes }}{% endif %}</td>

        {% for i in semaines %}
        {% with val=ligne.semaines_values|get_item:i %}
        {% with dispo_key=ligne.sem_parc_week|get_item:i %}
        {% with nb_dispo=disponibilites|get_item:dispo_key %}
        <td contenteditable="true" style="{{ nb_dispo|disponibilite_color }}">
          {% if val != None %}{{ val }}{% endif %}
        </td>
        {% endwith %}
        {% endwith %}
        {% endwith %}
        {% endfor %}

        <td>
          <button class="btn btn-primary btn-sm" onclick="saveRow(this)">Enregistrer</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function saveRow(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    let data = {
        "Fixed": cells[0].querySelector("input").checked ? 1 : 0,
        "semestre": cells[1].innerText.trim(),
        "parcours": cells[2].innerText.trim(),
        "code_matiere": cells[3].innerText.trim(),
        "block": parseInt(cells[4].innerText.trim()),
        "code_prof": cells[5].innerText.trim(),
        "type": cells[6].innerText.trim(),
        "nb_cours": parseInt(cells[7].innerText.trim()),
        "nb_groupes": parseInt(cells[8].innerText.trim()),
        "groupes": cells[9].innerText.trim()
    };

    const nbSemaines = {{ semaines|length }};
    for (let i = 10; i < 10 + nbSemaines; i++) {
        let val = cells[i].innerText.trim();
        data["Sem" + (i - 9)] = val === "" ? null : parseInt(val);
    }

    fetch("/programmation/update/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        alert(result.message);
        location.reload();
    })
    .catch(error => {
        console.error("Erreur :", error);
        alert("Erreur lors de la sauvegarde.");
    });
}
</script>

<script>

function saveAll() {
    const rows = document.querySelectorAll('tbody tr');
    let data = [];

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let ligne = {
            "Fixed": cells[0].querySelector("input").checked ? 1 : 0,
            "semestre": cells[1].innerText.trim(),
            "parcours": cells[2].innerText.trim(),
            "code_matiere": cells[3].innerText.trim(),
            "block": parseInt(cells[4].innerText.trim()),
            "code_prof": cells[5].innerText.trim(),
            "type": cells[6].innerText.trim(),
            "nb_cours": parseInt(cells[7].innerText.trim()),
            "nb_groupes": parseInt(cells[8].innerText.trim()),
            "groupes": cells[9].innerText.trim()
        };

        const nbSemaines = {{ semaines|length }};
        for (let i = 10; i < 10 + nbSemaines; i++) {
            let val = cells[i].innerText.trim();
            ligne["Sem" + (i - 9)] = val === "" ? null : parseInt(val);
        }

        data.push(ligne);
    });

    fetch("/programmation/update_all/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        alert(result.message);
        location.reload();
    })
    .catch(error => {
        console.error("Erreur :", error);
        alert("Erreur lors de la sauvegarde.");
    });
}
</script>

{% endblock %}
